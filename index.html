<!doctype html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>L.To Bank</title>

    <!-- PWA & Mobile Support -->
    <meta name="theme-color" content="#6366f1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <link
      rel="manifest"
      href="https://ngc7331-kor.github.io/LToBank/manifest.json"
    />
    <link
      rel="icon"
      href="https://ngc7331-kor.github.io/LToBank/app-icon.jpg"
      type="image/jpeg"
    />
    <link
      rel="apple-touch-icon"
      href="https://ngc7331-kor.github.io/LToBank/app-icon.jpg"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: linear-gradient(to bottom right, #eff6ff, #e0e7ff);
        min-height: 100vh;
        padding: 2rem 1rem;
      }
      .container {
        max-width: 1024px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 2rem;
      }
      .header-title {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 0.5rem;
      }
      .logo {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      h1 {
        font-size: 2.5rem;
        color: #1f2937;
      }
      .subtitle {
        color: #6b7280;
        font-size: 1rem;
      }

      .cards {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 2rem;
      }
      .card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .card-cw {
        border-top: 4px solid #f472b6;
      }
      .card-dk {
        border-top: 4px solid #60a5fa;
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
      .card-name {
        font-size: 1.5rem;
        font-weight: bold;
        color: #1f2937;
      }
      .card-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }
      .icon-cw {
        background: #fce7f3;
        color: #f472b6;
      }
      .icon-dk {
        background: #dbeafe;
        color: #60a5fa;
      }
      .card-info {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .info-label {
        color: #6b7280;
        font-size: 0.9rem;
      }
      .info-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1f2937;
        white-space: nowrap;
      }
      .info-interest {
        color: #f472b6;
      }
      .info-total {
        border-top: 1px solid #e5e7eb;
        padding-top: 0.5rem;
        margin-top: 0.5rem;
      }
      .total-label {
        font-weight: 600;
        color: #374151;
      }
      .total-value {
        font-size: 1.5rem;
        font-weight: bold;
        white-space: nowrap;
      }
      .total-cw {
        color: #f472b6;
      }
      .total-dk {
        color: #60a5fa;
      }

      .form-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }
      .form-title {
        font-size: 1.25rem;
        font-weight: bold;
        color: #1f2937;
        margin-bottom: 1rem;
      }
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
      .form-group {
        display: flex;
        flex-direction: column;
      }
      .form-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
      }
      .form-input,
      .form-select {
        padding: 0.75rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 1rem;
        transition: all 0.2s;
      }
      .form-input:focus,
      .form-select:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }
      .btn-submit {
        grid-column: 1 / -1;
        background: #6366f1;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-submit:hover {
        background: #4f46e5;
        transform: scale(1.02);
      }
      .btn-submit:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
      }

      .pending-card {
        background: #fff7ed;
        border: 2px solid #fb923c;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }
      .pending-title {
        font-size: 1.25rem;
        font-weight: bold;
        color: #c2410c;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .pending-count {
        background: #fb923c;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        font-size: 0.875rem;
      }

      .history-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
      .history-title {
        font-size: 1.25rem;
        font-weight: bold;
        color: #1f2937;
      }
      .history-buttons {
        display: flex;
        gap: 0.5rem;
      }
      .btn-mode {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-edit-mode {
        background: #10b981;
        color: white;
      }
      .btn-edit-mode:hover {
        background: #059669;
      }
      .btn-delete-mode {
        background: #ef4444;
        color: white;
      }
      .btn-delete-mode:hover {
        background: #dc2626;
      }
      .btn-cancel-mode {
        background: #6b7280;
        color: white;
      }
      .btn-cancel-mode:hover {
        background: #4b5563;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead {
        border-bottom: 2px solid #e5e7eb;
      }
      th {
        text-align: left;
        padding: 0.75rem 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151;
      }
      tbody tr {
        border-bottom: 1px solid #f3f4f6;
        transition: background 0.2s;
      }
      tbody tr:hover {
        background: #f9fafb;
      }
      td {
        padding: 0.75rem 0.5rem;
        font-size: 0.875rem;
      }
      .badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
      }
      .badge-cw {
        background: #fce7f3;
        color: #be185d;
      }
      .badge-dk {
        background: #dbeafe;
        color: #1e40af;
      }
      .badge-deposit {
        background: #d1fae5;
        color: #065f46;
      }
      .badge-withdraw {
        background: #fee2e2;
        color: #991b1b;
      }
      .badge-pending {
        background: #fef3c7;
        color: #b45309;
      }
      .amount {
        text-align: left;
        font-weight: 600;
        white-space: nowrap;
      }
      .amount-deposit {
        color: #059669;
      }
      .amount-withdraw {
        color: #dc2626;
      }
      .loading {
        text-align: center;
        padding: 2rem;
        font-size: 1.25rem;
        color: #6b7280;
      }
      .empty {
        text-align: center;
        padding: 2rem;
        color: #9ca3af;
      }

      .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 0.5rem; /* ìŠ¤í¬ë¡¤ë°” ê³µê°„ í™•ë³´ */
      }
      
      /* ì´ìœ ìŠ¤í¬ë¡¤ë°” ë””ìì¸ */
      .table-responsive::-webkit-scrollbar {
        height: 8px;
        background: transparent;
      }
      .table-responsive::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
      }
      .table-responsive::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        white-space: nowrap; /* í…Œì´ë¸” ì „ì²´ ì¤„ë°”ê¿ˆ ë°©ì§€ */
      }

      .action-btn {
        width: 36px;
        height: 36px;
        padding: 0;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin: 0 0.25rem;
      }
      .btn-edit {
        background: #10b981;
        color: white;
      }
      .btn-edit:hover {
        background: #059669;
      }
      .btn-delete {
        background: #ef4444;
        color: white;
      }
      .btn-delete:hover {
        background: #dc2626;
      }
      .btn-approve {
        background: #10b981;
        color: white;
      }
      .btn-approve:hover {
        background: #059669;
      }
      .btn-reject {
        background: #ef4444;
        color: white;
      }
      .btn-reject:hover {
        background: #dc2626;
      }
      .action-cell {
        text-align: center;
      }
      tbody tr.editable:hover {
        background: #f0fdf4;
        cursor: pointer;
      }
      tbody tr.deletable:hover {
        background: #fef2f2;
        cursor: pointer;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      }
      .modal-title {
        font-size: 1.25rem;
        font-weight: bold;
        color: #1f2937;
        margin-bottom: 1.5rem;
      }
      .modal-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 1.5rem;
      }
      .btn-cancel {
        flex: 1;
        background: #e5e7eb;
        color: #374151;
        padding: 0.75rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        cursor: pointer;
      }
      .btn-cancel:hover {
        background: #d1d5db;
      }
      .btn-save {
        flex: 1;
        background: #6366f1;
        color: white;
        padding: 0.75rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        cursor: pointer;
      }
      .btn-save:hover {
        background: #4f46e5;
      }

      @media (max-width: 768px) {
        .cards {
          grid-template-columns: 1fr;
        }
        .form-grid {
          grid-template-columns: 1fr;
        }
        h1 {
          font-size: 2rem;
        }
        table {
          font-size: 0.75rem;
        }
        th,
        td {
          padding: 0.5rem 0.25rem;
        }
      }

      /* Install Button Style */
      .install-btn {
        margin-top: 15px;
        background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: 700;
        font-size: 0.9rem;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .install-btn:active {
        transform: scale(0.95);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-title">
          <img
            src="https://lh3.googleusercontent.com/d/13zerx7kd9zBQUhCCr_qV3u5GZdl7Qyy6"
            alt="Logo"
            class="logo"
            id="logo"
          />
          <h1>L.To Bank</h1>
        </div>
        <p class="subtitle">íŠ¹ë³„í•œ ì €ì¶•í†µì¥ (ì—° 3.1%)</p>

        <!-- PWA Install Button -->
        <button id="installAppBtn" class="install-btn" style="display: none">
          ğŸ“¥ ì•± ì„¤ì¹˜í•˜ê¸°
        </button>
      </div>

      <div class="cards">
        <div class="card card-cw">
          <div class="card-header">
            <div class="card-name">ì±„ì›</div>
            <div class="card-icon icon-cw">ğŸ“ˆ</div>
          </div>
          <div class="card-info">
            <div class="info-row">
              <span class="info-label">ì €ì¶•ì•¡</span>
              <span class="info-value" id="cw-deposit">â‚©0</span>
            </div>
            <div class="info-row">
              <span class="info-label">ì´ì</span>
              <span class="info-value info-interest" id="cw-interest">+â‚©0</span>
            </div>
            <div class="info-row info-total">
              <span class="total-label">ì´ì•¡</span>
              <span class="total-value total-cw" id="cw-total">â‚©0</span>
            </div>
          </div>
        </div>

        <div class="card card-dk">
          <div class="card-header">
            <div class="card-name">ë„ê¶Œ</div>
            <div class="card-icon icon-dk">ğŸ“ˆ</div>
          </div>
          <div class="card-info">
            <div class="info-row">
              <span class="info-label">ì €ì¶•ì•¡</span>
              <span class="info-value" id="dk-deposit">â‚©0</span>
            </div>
            <div class="info-row">
              <span class="info-label">ì´ì</span>
              <span class="info-value info-interest" id="dk-interest">+â‚©0</span>
            </div>
            <div class="info-row info-total">
              <span class="total-label">ì´ì•¡</span>
              <span class="total-value total-dk" id="dk-total">â‚©0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ìŠ¹ì¸ ëŒ€ê¸° ì¹´ë“œ (ë¶€ëª¨ë§Œ) -->
      <div id="pendingSection" style="display: none">
        <div class="pending-card">
          <h3 class="pending-title">
            â° ìŠ¹ì¸ ëŒ€ê¸°
            <span class="pending-count" id="pendingCount">0</span>
          </h3>
          <div id="pending-container">
            <div class="loading">ëŒ€ê¸°ì¤‘ì¸ ê±°ë˜ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...</div>
          </div>
        </div>
      </div>

      <div class="form-card">
        <h3 class="form-title">ìƒˆ ê±°ë˜ ë“±ë¡</h3>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">ì´ë¦„</label>
            <select id="name" class="form-select">
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              <option value="cw">ì±„ì›</option>
              <option value="dk">ë„ê¶Œ</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ë‚ ì§œ</label>
            <input type="date" id="date" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label">êµ¬ë¶„</label>
            <select id="type" class="form-select">
              <option value="ì…ê¸ˆ">ì…ê¸ˆ</option>
              <option value="ì¶œê¸ˆ">ì¶œê¸ˆ</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ê¸ˆì•¡ (ì›)</label>
            <input
              type="number"
              id="amount"
              class="form-input"
              placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”"
            />
          </div>
          <button class="btn-submit" onclick="handleSubmit()">í™•ì¸</button>
        </div>
      </div>

      <div class="history-card">
        <div class="history-header">
          <h3 class="history-title">ìµœê·¼ ê±°ë˜ ë‚´ì—­</h3>
          <div class="history-buttons">
            <button
              id="editModeBtn"
              class="btn-mode btn-edit-mode"
              onclick="enterEditMode()"
            >
              ìˆ˜ì •
            </button>
            <button
              id="deleteModeBtn"
              class="btn-mode btn-delete-mode"
              onclick="enterDeleteMode()"
            >
              ì‚­ì œ
            </button>
          </div>
        </div>
        <div id="history-container">
          <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>
    </div>

    <div id="editModal" class="modal">
      <div class="modal-content">
        <h3 class="modal-title">ê±°ë˜ ìˆ˜ì •</h3>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">ì´ë¦„</label>
            <select id="edit-name" class="form-select">
              <option value="cw">ì±„ì›</option>
              <option value="dk">ë„ê¶Œ</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ë‚ ì§œ</label>
            <input type="date" id="edit-date" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label">êµ¬ë¶„</label>
            <select id="edit-type" class="form-select">
              <option value="ì…ê¸ˆ">ì…ê¸ˆ</option>
              <option value="ì¶œê¸ˆ">ì¶œê¸ˆ</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ê¸ˆì•¡ (ì›)</label>
            <input type="number" id="edit-amount" class="form-input" />
          </div>
        </div>
        <div class="modal-buttons">
          <button class="btn-cancel" onclick="closeEditModal()">ì·¨ì†Œ</button>
          <button class="btn-save" onclick="saveEdit()">ì €ì¥</button>
        </div>
      </div>
    </div>

    <script>
      // GitHub Pagesì—ì„œ ì§ì ‘ ì ‘ì† ì‹œ ì°¨ë‹¨ (ë³´ì•ˆ ê°•í™”)
      if (window.location.hostname.includes("github.io")) {
        document.body.innerHTML = `
        <div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;text-align:center;font-family:sans-serif;">
          <h2 style="color:#ef4444;">â›” ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</h2>
          <p>ì´ í˜ì´ì§€ëŠ” ì •ì  íŒŒì¼ì´ë©°, ë³´ì•ˆìƒ ê¸°ëŠ¥ì„ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
          <p><strong>ì•±ìŠ¤ìŠ¤í¬ë¦½íŠ¸(Google Apps Script) ì£¼ì†Œ</strong>ë¡œ ì ‘ì†í•´ì£¼ì„¸ìš”.</p>
        </div>
      `;
        throw new Error("GitHub Pages Access Blocked");
      }

      let transactions = [];
      let pendingTransactions = [];
      let editingUniqueId = null; // ìˆ˜ì •: rowId -> uniqueId
      let currentMode = "normal";
      let isParent = false;
      let deferredPrompt;

      // PWA Install Prompt Logic
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const installBtn = document.getElementById("installAppBtn");
        if (installBtn) {
          installBtn.style.display = "inline-flex";
        }
      });

      document
        .getElementById("installAppBtn")
        ?.addEventListener("click", async () => {
          if (!deferredPrompt) return;
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          console.log(`User response to the install prompt: ${outcome}`);
          deferredPrompt = null;
          document.getElementById("installAppBtn").style.display = "none";
        });

      // ì´ë¦„ ë§¤í•‘ í•¨ìˆ˜
      function getDisplayName(name) {
        if (name === "cw") return "ì±„ì›";
        if (name === "dk") return "ë„ê¶Œ";
        if (name === "admin" || name === "parent") return "ì•„ë¹ "; // ì•„ë¹ ë¡œ í†µí•©
        return name;
      }

      window.onload = function () {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("date").value = today;

        document.getElementById("logo").onerror = function () {
          this.style.display = "none";
        };

        // ë¶€ëª¨ì¸ì§€ í™•ì¸
        google.script.run
          .withSuccessHandler(function (result) {
            isParent = result;
            if (isParent) {
              document.getElementById("pendingSection").style.display = "block";
              loadPendingTransactions();
            }
            loadTransactions();
          })
          .checkIsParent();
      };

      // ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ (ê¸°ë¡ì ì‹œíŠ¸) - ê¸°ì¡´ ë¡œì§ ìœ ì§€
      function loadPendingTransactions() {
        google.script.run
          .withSuccessHandler(function (data) {
            pendingTransactions = data;
            updatePendingDisplay();
          })
          .withFailureHandler(function (error) {
            console.error("ìŠ¹ì¸ ëŒ€ê¸° ë¡œë“œ ì‹¤íŒ¨:", error);
          })
          .getPendingTransactions();
      }

      function updatePendingDisplay() {
        const container = document.getElementById("pending-container");
        const count = document.getElementById("pendingCount");

        count.textContent = pendingTransactions.length;

        if (pendingTransactions.length === 0) {
          container.innerHTML =
            '<div class="empty">ìŠ¹ì¸ ëŒ€ê¸°ì¤‘ì¸ ê±°ë˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        let html =
          '<div class="table-responsive"><table><thead><tr><th>ë‚ ì§œ</th><th>ê¸°ë¡ì</th><th>ëŒ€ìƒ</th><th>êµ¬ë¶„</th><th>ê¸ˆì•¡</th><th>ì‘ì—…</th><th>ìŠ¹ì¸</th></tr></thead><tbody>';

        pendingTransactions.forEach((t) => {
          const nameBadge = t.name === "cw" ? "badge-cw" : "badge-dk";
          const typeBadge =
            t.type === "ì…ê¸ˆ" ? "badge-deposit" : "badge-withdraw";
          const sign = t.type === "ì…ê¸ˆ" ? "+" : "-";
          const actionBadge = "badge-pending";

          // í‘œì‹œìš© ì´ë¦„ ë³€í™˜
          const displayName = getDisplayName(t.name);
          const displayRecorder = getDisplayName(t.recorder);

          html += `
          <tr>
            <td>${t.date}</td>
            <td>${displayRecorder}</td>
            <td><span class="badge ${nameBadge}">${displayName}</span></td>
            <td><span class="badge ${typeBadge}">${t.type}</span></td>
            <td class="amount">${sign}â‚©${formatNumber(t.amount)}</td>
            <td><span class="badge ${actionBadge}">${t.action}</span></td>
            <td class="action-cell">
              <button class="action-btn btn-approve" onclick="approveTransaction(${t.id})" title="ìŠ¹ì¸">âœ“</button>
              <button class="action-btn btn-reject" onclick="rejectTransaction(${t.id})" title="ê±°ì ˆ">âœ—</button>
            </td>
          </tr>
        `;
        });

        html += "</tbody></table>";
        container.innerHTML = html;
      }

      function approveTransaction(rowId) {
        if (!confirm("ì´ ê±°ë˜ë¥¼ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        google.script.run
          .withSuccessHandler(function () {
            alert("ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!");
            loadPendingTransactions();
            loadTransactions();
          })
          .withFailureHandler(function (error) {
            alert("ìŠ¹ì¸ ì‹¤íŒ¨: " + error.message);
          })
          .approveTransaction(rowId);
      }

      function rejectTransaction(rowId) {
        if (!confirm("ì´ ê±°ë˜ë¥¼ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        google.script.run
          .withSuccessHandler(function () {
            alert("ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadPendingTransactions();
          })
          .withFailureHandler(function (error) {
            alert("ê±°ì ˆ ì‹¤íŒ¨: " + error.message);
          })
          .rejectTransaction(rowId);
      }

      // ì™„ë£Œëœ ê±°ë˜ ëª©ë¡ (ê°œì¸ ì‹œíŠ¸) - ë³€ê²½ëœ ë¡œì§ ì ìš©
      function loadTransactions() {
        google.script.run
          .withSuccessHandler(function (data) {
            transactions = data;
            updateDisplay();
          })
          .withFailureHandler(function (error) {
            alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + error.message);
          })
          .getTransactions();
      }

      function updateDisplay() {
        updateBalances();
        updateHistory();
      }

      function updateBalances() {
        google.script.run
          .withSuccessHandler(function (data) {
            const interest = calculateInterestFromTransactions(
              data.transactions,
            ); // ì—¬ê¸° ë¡œì§ì€ í”„ë¡ íŠ¸ì—”ë“œ ê³„ì‚° ìœ ì§€?
            // getPersonalSheetDataëŠ” ì´ì œ transactionì„ ë¹ˆ ë°°ì—´ë¡œ ì£¼ë¯€ë¡œ, interest ê³„ì‚° ë¡œì§ ìˆ˜ì • í•„ìš”?
            // ì•„ë‹ˆë‹¤, calculateInterestFromTransactionsëŠ” transactions ë°°ì—´(ì „ì²´ë°ì´í„°)ì„ ì¸ìë¡œ ë°›ëŠ”ë‹¤.
            // í•˜ì§€ë§Œ data.transactionsëŠ” ë¹ˆ ë°°ì—´ì´ë‹¤.
            // ë”°ë¼ì„œ calculateInterestFromTransactionsëŠ” `transactions` (ì „ì—­ ë³€ìˆ˜, ì „ì²´ ë¦¬ìŠ¤íŠ¸)ë¥¼ ì¨ì•¼ í•¨.

            // í•˜ì§€ë§Œ ì´ í•¨ìˆ˜ëŠ” 'cw' ë°ì´í„°ë§Œ í•„ìš”í•¨.
            // transactions ì „ì—­ ë³€ìˆ˜ì—ì„œ cw ë°ì´í„°ë§Œ í•„í„°ë§í•´ì•¼ í•¨.
            const cwTxs = transactions.filter((t) => t.sheetName === "cw");
            const interestVal = calculateInterestFromTransactions(cwTxs); // ìˆ˜ì •

            document.getElementById("cw-deposit").textContent =
              "â‚©" + formatNumber(data.deposit);
            document.getElementById("cw-interest").textContent =
              "+â‚©" + formatNumber(interestVal);
            document.getElementById("cw-total").textContent =
              "â‚©" + formatNumber(data.deposit + interestVal);
          })
          .getPersonalSheetData("cw");

        google.script.run
          .withSuccessHandler(function (data) {
            const dkTxs = transactions.filter((t) => t.sheetName === "dk");
            const interestVal = calculateInterestFromTransactions(dkTxs); // ìˆ˜ì •

            document.getElementById("dk-deposit").textContent =
              "â‚©" + formatNumber(data.deposit);
            document.getElementById("dk-interest").textContent =
              "+â‚©" + formatNumber(interestVal);
            document.getElementById("dk-total").textContent =
              "â‚©" + formatNumber(data.deposit + interestVal);
          })
          .getPersonalSheetData("dk");
      }

      function calculateInterestFromTransactions(txs) {
        // ë‚ ì§œìˆœ ì˜¤ë¦„ì°¨ìˆœ(ê³¼ê±°->ë¯¸ë˜) ì •ë ¬ í•„ìš” (ì´ì ê³„ì‚° ìœ„í•´)
        const sortedTxs = [...txs].sort(
          (a, b) => new Date(a.date) - new Date(b.date),
        );

        const today = new Date(
          document.getElementById("date").value || new Date(),
        );
        let deposits = [];

        sortedTxs.forEach((tx) => {
          if (tx.type === "ì…ê¸ˆ") {
            deposits.push({
              amount: tx.amount,
              date: tx.date,
              remainingAmount: tx.amount,
            });
          } else if (tx.type === "ì¶œê¸ˆ") {
            let remainingWithdrawal = tx.amount;
            for (
              let i = 0;
              i < deposits.length && remainingWithdrawal > 0;
              i++
            ) {
              if (deposits[i].remainingAmount > 0) {
                const deduction = Math.min(
                  deposits[i].remainingAmount,
                  remainingWithdrawal,
                );
                deposits[i].remainingAmount -= deduction;
                remainingWithdrawal -= deduction;
              }
            }
          }
        });

        deposits = deposits.filter((d) => d.remainingAmount > 0);

        let totalInterest = 0;
        deposits.forEach((deposit) => {
          const depositDate = new Date(deposit.date);
          const days = Math.floor(
            (today - depositDate) / (1000 * 60 * 60 * 24),
          );
          if (days > 0) {
            totalInterest += (deposit.remainingAmount * 0.031 * days) / 365;
          }
        });

        return Math.ceil(totalInterest / 10) * 10;
      }

      function updateHistory() {
        const container = document.getElementById("history-container");
        // transactionsëŠ” ì´ë¯¸ ë‚ ì§œ ì—­ìˆœ(ìµœì‹ ->ê³¼ê±°)ìœ¼ë¡œ ì •ë ¬ë˜ì–´ ì˜´
        // í•˜ì§€ë§Œ í˜¹ì‹œ ëª¨ë¥´ë‹ˆ slice
        const recent = transactions.slice(0, 50); // ìµœê·¼ 50ê°œë§Œ? ìƒë‹¨ 10ê°œë§Œ?
        // ê¸°ì¡´ì—ëŠ” slice(-10).reverse() ì˜€ìŒ. ë°±ì—”ë“œì—ì„œ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì¤¬ì—ˆê¸° ë•Œë¬¸.
        // ì´ì œ ë°±ì—”ë“œì—ì„œ ë‚´ë¦¼ì°¨ìˆœ(ìµœì‹ ìˆœ)ìœ¼ë¡œ ì¤Œ.
        // ë”°ë¼ì„œ ì•ë¶€ë¶„ë§Œ ìë¥´ë©´ ë¨.
        const displayList = recent.slice(0, 10);

        if (displayList.length === 0) {
          container.innerHTML =
            '<div class="empty">ì•„ì§ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        let html =
          '<div class="table-responsive"><table><thead><tr><th>ë‚ ì§œ</th><th>ì´ë¦„</th><th>êµ¬ë¶„</th><th>ê¸ˆì•¡</th><th>ê¸°ë¡ì</th>';
        if (currentMode === "edit" || currentMode === "delete")
          html += "<th>ì‘ì—…</th>";
        html += "</tr></thead><tbody>";

        displayList.forEach((t) => {
          // ì´ë¦„ í‘œì‹œ: ì´ë¯¸ ì„œë²„ì—ì„œ í•œê¸€ë¡œ ì˜¬ ìˆ˜ë„ ìˆì§€ë§Œ(ë°±ì—”ë“œ ë¡œì§ìƒ),
          // ì—¬ê¸°ì„œ í•œë²ˆ ë” ì²´í¬. (t.nameì€ 'ì±„ì›' or 'ë„ê¶Œ'ìœ¼ë¡œ ì˜´)
          // t.sheetNameì€ 'cw' or 'dk'
          const nameBadge = t.sheetName === "cw" ? "badge-cw" : "badge-dk";
          const typeBadge =
            t.type === "ì…ê¸ˆ" ? "badge-deposit" : "badge-withdraw";
          const amountClass =
            t.type === "ì…ê¸ˆ" ? "amount-deposit" : "amount-withdraw";
          const sign = t.type === "ì…ê¸ˆ" ? "+" : "-";

          // ì´ë¦„ ë³€í™˜ (ì„œë²„ì—ì„œ ì´ë¯¸ í•œê¸€ë¡œ ì¤„ ìˆ˜ë„ ìˆìŒ)
          const displayName = getDisplayName(t.name);
          // ê¸°ë¡ì ë³€í™˜
          const displayRecorder = getDisplayName(t.recorder || "-");

          const rowClass =
            currentMode === "edit"
              ? "editable"
              : currentMode === "delete"
                ? "deletable"
                : "";

          html += `<tr class="${rowClass}"><td>${t.date}</td><td><span class="badge ${nameBadge}">${displayName}</span></td>
                 <td><span class="badge ${typeBadge}">${t.type}</span></td>
                 <td class="amount ${amountClass}">${sign}â‚©${formatNumber(t.amount)}</td><td>${displayRecorder}</td>`;

          if (currentMode === "edit") {
            // uniqueId ì‚¬ìš©
            html += `<td class="action-cell"><button class="action-btn btn-edit" onclick="editTransaction('${t.uniqueId}', '${t.sheetName}', '${t.date}', '${t.type}', ${t.amount})">âœ“</button></td>`;
          } else if (currentMode === "delete") {
            html += `<td class="action-cell"><button class="action-btn btn-delete" onclick="deleteTransaction('${t.uniqueId}')">ğŸ—‘</button></td>`;
          }

          html += "</tr>";
        });

        html += "</tbody></table></div>";
        container.innerHTML = html;
      }

      function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }

      function handleSubmit() {
        const name = document.getElementById("name").value;
        const date = document.getElementById("date").value;
        const type = document.getElementById("type").value;
        const amount = parseInt(document.getElementById("amount").value);

        if (!name) {
          alert("ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }
        if (!amount || amount <= 0) {
          alert("ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        const btn = document.querySelector(".btn-submit");
        btn.disabled = true;
        btn.textContent = "ì €ì¥ ì¤‘...";

        google.script.run
          .withSuccessHandler(function (result) {
            if (result.needsApproval) {
              alert("ê±°ë˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!\në¶€ëª¨ë‹˜ì˜ ìŠ¹ì¸ í›„ ë°˜ì˜ë©ë‹ˆë‹¤.");
            } else {
              alert("ê±°ë˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
            }
            document.getElementById("name").value = "";
            document.getElementById("amount").value = "";
            document.getElementById("date").value = new Date()
              .toISOString()
              .split("T")[0];
            loadTransactions();
            if (isParent) loadPendingTransactions();
            btn.disabled = false;
            btn.textContent = "í™•ì¸";
          })
          .withFailureHandler(function (error) {
            alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
            btn.disabled = false;
            btn.textContent = "í™•ì¸";
          })
          .addTransaction({ name, date, type, amount });
      }

      function enterEditMode() {
        currentMode = "edit";
        document.getElementById("editModeBtn").textContent = "ìˆ˜ì • ì·¨ì†Œ";
        document.getElementById("editModeBtn").className =
          "btn-mode btn-cancel-mode";
        document.getElementById("editModeBtn").onclick = exitMode;
        document.getElementById("deleteModeBtn").style.display = "none";
        updateHistory();
      }

      function enterDeleteMode() {
        currentMode = "delete";
        document.getElementById("deleteModeBtn").textContent = "ì‚­ì œ ì·¨ì†Œ";
        document.getElementById("deleteModeBtn").className =
          "btn-mode btn-cancel-mode";
        document.getElementById("deleteModeBtn").onclick = exitMode;
        document.getElementById("editModeBtn").style.display = "none";
        updateHistory();
      }

      function exitMode() {
        currentMode = "normal";
        document.getElementById("editModeBtn").textContent = "ìˆ˜ì •";
        document.getElementById("editModeBtn").className =
          "btn-mode btn-edit-mode";
        document.getElementById("editModeBtn").onclick = enterEditMode;
        document.getElementById("editModeBtn").style.display = "inline-block";
        document.getElementById("deleteModeBtn").textContent = "ì‚­ì œ";
        document.getElementById("deleteModeBtn").className =
          "btn-mode btn-delete-mode";
        document.getElementById("deleteModeBtn").onclick = enterDeleteMode;
        document.getElementById("deleteModeBtn").style.display = "inline-block";
        updateHistory();
      }

      // ìˆ˜ì •: id -> uniqueId ('cw-5')
      // nameì¸ìëŠ” sheetNameì´ ì•„ë‹ˆë¼ UIì— í‘œì‹œí•  ì´ë¦„, í•˜ì§€ë§Œ ë¡œì§ìƒ sheetName('cw'/'dk')ê°€ í•„ìš”
      function editTransaction(uniqueId, sheetName, date, type, amount) {
        editingUniqueId = uniqueId;
        document.getElementById("edit-name").value = sheetName; // 'cw' or 'dk'
        document.getElementById("edit-date").value = date;
        document.getElementById("edit-type").value = type;
        document.getElementById("edit-amount").value = amount;
        document.getElementById("editModal").classList.add("active");
        exitMode();
      }

      function closeEditModal() {
        document.getElementById("editModal").classList.remove("active");
        editingUniqueId = null;
      }

      function saveEdit() {
        const name = document.getElementById("edit-name").value; // 'cw' or 'dk'
        const date = document.getElementById("edit-date").value;
        const type = document.getElementById("edit-type").value;
        const amount = parseInt(document.getElementById("edit-amount").value);

        if (!amount || amount <= 0) {
          alert("ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        google.script.run
          .withSuccessHandler(function (result) {
            if (result.needsApproval) {
              alert("ìˆ˜ì •ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤!\në¶€ëª¨ë‹˜ì˜ ìŠ¹ì¸ í›„ ë°˜ì˜ë©ë‹ˆë‹¤.");
            } else {
              alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
            }
            closeEditModal();
            loadTransactions();
            if (isParent) loadPendingTransactions();
          })
          .withFailureHandler(function (error) {
            alert("ìˆ˜ì • ì‹¤íŒ¨: " + error.message);
          })
          .updateTransaction(editingUniqueId, { name, date, type, amount });
      }

      function deleteTransaction(uniqueId) {
        if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        google.script.run
          .withSuccessHandler(function (result) {
            if (result.needsApproval) {
              alert("ì‚­ì œê°€ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤!\në¶€ëª¨ë‹˜ì˜ ìŠ¹ì¸ í›„ ë°˜ì˜ë©ë‹ˆë‹¤.");
            } else {
              alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!");
            }
            exitMode();
            loadTransactions();
            if (isParent) loadPendingTransactions();
          })
          .withFailureHandler(function (error) {
            alert("ì‚­ì œ ì‹¤íŒ¨: " + error.message);
          })
          .deleteTransaction(uniqueId);
      }
    </script>
  </body>
</html>
